# WP2Static Add-on: Copy to Folder

The WP2Static Copy to Folder Deployment Add-on is an extension for the [WP2Static](https://wp2static.com/) plugin. It allows you to automatically copy your generated static WordPress site to a different folder on the same server where your WordPress installation resides.

## What it Does

When WP2Static finishes exporting your WordPress site into a static HTML version (typically located in `wp-content/uploads/wp2static-processed-site`), this add-on takes over and copies the entire contents of that processed site directory to a target folder you specify.

This is useful for:

*   Deploying your static site to a directory served directly by your web server (e.g., a subdirectory of your main domain, or a different virtual host pointing to a local path).
*   Keeping a local copy of your static site in a specific, easily accessible location.
*   Integrating with other scripts or processes that expect the static site files in a particular directory.

## Who it's For

This add-on is for WordPress users who utilize WP2Static to generate a static version of their site and need a simple, automated way to deploy or copy these static files to another location on the *same server*.

## Why it's Useful

*   **Simplicity:** Offers a straightforward method for local deployment without needing external services, FTP, or complex deployment scripts.
*   **Automation:** Integrates directly into the WP2Static deployment process, copying files automatically after generation.
*   **Control:** You specify the exact target directory for your static files.
*   **Flexibility:** Options to clean the target directory before deployment and to include additional custom files or folders.

## Features

*   **Define Target Directory:** Specify the absolute path on your server where the static site should be copied.
*   **Clean Target Directory:** Optionally, automatically remove all existing files and folders from the target directory before copying the new static site.
*   **Extra Source Folder:** Optionally, specify an additional folder on your server whose contents will also be copied into the target directory after the main static site files. This is useful for including files not generated by WordPress, such as a custom `.htaccess`, verification files, or other static assets.

## Requirements

*   A working WordPress installation.
*   The main [WP2Static](https://wp2static.com/) plugin installed and activated.
*   PHP version 7.3 or higher.

## Installation

1.  **Install WP2Static:** If you haven't already, install and activate the core [WP2Static plugin](https://wp2static.com/) from the WordPress plugin directory or its official website.
2.  **Download the Add-on:**
    *   Download the latest `wp2static-addon-copy.zip` file from the [official GitHub releases page](https://github.com/twardoch/wp2static-addon-copy/releases).
3.  **Upload and Activate in WordPress:**
    *   In your WordPress admin area, navigate to **Plugins > Add New**.
    *   Click the **Upload Plugin** button at the top.
    *   Choose the `wp2static-addon-copy.zip` file you downloaded and click **Install Now**.
    *   After installation, click **Activate Plugin**.

## Configuration

1.  Once activated, navigate to **WP2Static > Addons** in your WordPress admin menu.
2.  Locate **Copy Deployment** in the list of available add-ons.
3.  If it's marked as "Disabled", click the status toggle to **Enable** it.
4.  Click the **Configure** button next to "Copy Deployment".

You will see the following options:

*   **Target folder (absolute):**
    *   Enter the full absolute path to the folder on your server where you want the static site files to be copied. For example: `/var/www/mystaticsite` or `/home/user/public_html/static_version`.
    *   Ensure this directory is writable by your web server.
*   **Clean target folder before deployment:**
    *   Check this box if you want the add-on to delete all contents of the "Target folder" before copying the new files. This ensures a clean deployment without any leftover files from previous exports.
*   **Extra source folder (absolute):**
    *   (Optional) If you have other files or folders (e.g., a custom `.htaccess`, `robots.txt`, or a directory of shared assets) that you want to include with your static site, enter the full absolute path to that folder here. Its contents will be copied into the "Target folder" after the main static site files are copied.

After configuring the options, click **Save Options**.

## Usage

### Via WordPress UI

1.  After configuring the add-on, ensure that "Copy Deployment" is selected as the active deployment method in the main **WP2Static > Deploy static website** tab (or relevant deployment settings area within WP2Static).
2.  Generate your static site using WP2Static as you normally would (e.g., by clicking "Generate static site" or "Run all actions").
3.  Once WP2Static has processed your site, this add-on will automatically be triggered to copy the files to your configured "Target folder".
4.  You can check the WP2Static logs (usually under **WP2Static > Logs**) for messages related to the copy process, such as "Copy Addon deploying", "Copying /path/to/processed-site to /path/to/targetFolder", etc.

### Via WP-CLI

The add-on registers a basic WP-CLI command structure, but its functionality is currently limited.

*   **Command:** `wp wp2static copy <action>`

*   **Available Actions:**
    *   `options`: This subcommand is intended for managing add-on options via WP-CLI. However, it is currently a placeholder and outputs: "TBC setting options for Copy addon". Full CLI-based option management is not yet implemented.

Triggering the actual deployment/copy process via WP-CLI depends on the main WP2Static plugin's CLI commands for running an export and deployment. This add-on will hook into that process if it's the enabled deployer.

---

## Technical Documentation

This section provides a more detailed look into how the WP2Static Copy to Folder Add-on works internally.

### How it Works (Code Architecture)

The plugin follows a standard WordPress plugin structure with its core logic organized into PHP classes.

*   **Plugin Initialization (`wp2static-addon-copy.php`):**
    *   This is the main plugin file that WordPress recognizes.
    *   It defines essential constants like `WP2STATIC_COPY_PATH` (plugin's directory path) and `WP2STATIC_COPY_VERSION`.
    *   It includes the Composer `vendor/autoload.php` file for class loading.
    *   It instantiates the `WP2StaticCopy\Controller` class and calls its `run()` method to initialize the add-on.
    *   It registers WordPress activation and deactivation hooks:
        *   `Controller::activate`: Called on plugin activation. It creates the custom database table used for storing the add-on's options and seeds it with default values.
        *   `Controller::deactivate`: Called on plugin deactivation. Currently, this method is empty but could be used for cleanup tasks in the future.

*   **Controller (`src/Controller.php`):**
    *   This class is responsible for integrating the add-on with the WordPress admin interface and the WP2Static plugin.
    *   The `run()` method sets up various WordPress actions and filters:
        *   `wp2static_add_menu_items`: Adds a link to the add-on's settings page under the "WP2Static" admin menu (specifically within the "Addons" section).
        *   `admin_post_wp2static_copy_save_options`: Defines a handler for when the options form (in `views/copy-page.php`) is submitted. It saves the sanitized option values to the database.
        *   `wp2static_deploy`: This is a crucial hook. It listens for the WP2Static deployment action. If this "Copy Deployment" add-on is the currently enabled deployer, it triggers the file copying process by calling `Deployer->uploadFiles()`.
        *   `admin_menu`: Registers the submenu page for the add-on's options, making it accessible.
        *   `wp2static_register_addon`: Registers this add-on with the main WP2Static plugin, allowing WP2Static to recognize and manage it.
    *   **Options Management:**
        *   Options are stored in a custom database table: `{$wpdb->prefix}wp2static_addon_copy_options`.
        *   `createOptionsTable()`: Defines and creates this table schema during activation.
        *   `seedOptions()`: Populates the table with default option names and initial values.
        *   `getOptions()`: Retrieves all options from the database.
        *   `saveOption()`: Updates a specific option's value (used internally by `saveOptionsFromUI`).
        *   `getValue(string $name)`: Retrieves the value of a single named option.
    *   `renderCopyPage()`: This method is called to display the add-on's settings page. It prepares data (like current option values and nonce fields) and then includes `views/copy-page.php` to render the HTML form.

*   **Deployer (`src/Deployer.php`):**
    *   This class contains the core logic for the file copying operations.
    *   `uploadFiles(string $processed_site_path)`: This is the main method executed during deployment.
        1.  It retrieves the necessary options (`copyTargetFolder`, `copyRemoveTarget`, `copyExtraFolder`) using `Controller::getValue()`.
        2.  It performs basic validation (e.g., checking if the processed site path and target folder exist).
        3.  If the "Clean target folder" option (`copyRemoveTarget`) is enabled, it calls the `rrmdir()` helper function to recursively delete all contents of the target directory.
        4.  It then calls the `xcopy()` helper function to recursively copy all files and directories from the `$processed_site_path` (where WP2Static places the generated static site) to the `copyTargetFolder`.
        5.  If an "Extra source folder" (`copyExtraFolder`) is specified and exists, it again uses `xcopy()` to copy the contents of this extra folder into the `copyTargetFolder`.
        6.  Logs its actions using `\WP2Static\WsLog::l()`.
    *   **Helper Functions:**
        *   `rrmdir(string $path)`: A utility function to recursively remove a directory and all its contents. It's careful not to delete the root directory itself if given an empty path component.
        *   `xcopy(string $source, string $dest, int $permissions = 0755)`: A utility function to recursively copy files and directories from a source to a destination. It attempts to preserve symlinks and sets directory permissions. It includes a `hashDirectory()` check to prevent infinite loops if, by some misconfiguration, the source is a parent of the destination (though this is less of a concern for this plugin's typical usage).
        *   `hashDirectory(string $directory)`: Calculates an MD5 hash based on the files within a directory. Used by `xcopy` to detect if a source directory has changed during a recursive copy operation (primarily for the self-copying prevention).

*   **CLI (`src/CLI.php`):**
    *   This class registers WP-CLI commands for the add-on.
    *   `\WP_CLI::add_command('wp2static copy', [CLI::class, 'copy'])` registers the main `wp wp2static copy` command.
    *   The `copy(array $args, array $assoc_args)` method currently only handles an `options` subcommand, which, as noted, is a placeholder ("TBC setting options for Copy addon").

*   **Views (`views/copy-page.php`):**
    *   This is a PHP file that generates the HTML for the add-on's settings page in the WordPress admin area.
    *   It displays a form with input fields for "Target folder", a checkbox for "Clean target folder", and an input field for "Extra source folder".
    *   It uses WordPress functions like `esc_url()`, `admin_url()`, and `wp_nonce_field()` for security and proper URL generation.

*   **Uninstall (`uninstall.php`):**
    *   This script is executed when the plugin is uninstalled from WordPress.
    *   Its primary function is to clean up by dropping the custom database table (`{$wpdb->prefix}wp2static_addon_copy_options`) that the add-on created.

*   **MIME Types (`src/MimeTypes.php`):**
    *   This class (`WP2StaticCopy\MimeTypes`) provides a static method `guessMimeType(string $filename)` to determine the MIME type of a file. It first checks against a comprehensive internal list of known extensions and then falls back to using PHP's `finfo` functions if available.
    *   *Note: It's not immediately clear if this MimeTypes class is actively used within the Copy to Folder add-on's current functionality. It might be a utility intended for broader use within the WP2Static ecosystem or for future features.*

### Key Files and Directories

*   `wp2static-addon-copy.php`: Main plugin file (bootstrap).
*   `src/`: Contains the core PHP classes:
    *   `Controller.php`: Handles WordPress integration, admin UI, and option management.
    *   `Deployer.php`: Contains the logic for copying files.
    *   `CLI.php`: Implements WP-CLI command integration.
    *   `MimeTypes.php`: Utility for guessing file MIME types.
*   `views/`:
    *   `copy-page.php`: PHP template for the admin options page.
*   `vendor/`: (Typically created by Composer) Contains third-party libraries. This plugin has no specific PHP library dependencies in its `composer.json` `require` section for runtime, but `autoload.php` from Composer is used.
*   `composer.json`: Defines project metadata, PHP version requirements (>=7.3), development dependencies, and scripts for development tasks (testing, linting, building).
*   `LICENSE.txt`: Contains the Unlicense text.
*   `CHANGELOG.md`: **Note:** The current `CHANGELOG.md` in the repository appears to be for the "WP2Static S3 Add-on", not this "Copy to Folder" add-on. This is likely an error.
*   `.github/workflows/codequality.yml`: Defines a GitHub Actions workflow that runs automated checks (Composer validation, linting, PHPStan) on pushes and pull requests to the `master` branch, testing against PHP 7.3 and 7.4.
*   `tools/`: Contains utility scripts and configuration for development:
    *   `build_release.sh`: Shell script to package the plugin into a distributable `.zip` file. It handles installing production-only Composer dependencies before packaging.
    *   `phpcs.xml`: Configuration file for PHP_CodeSniffer, defining the coding standards.
    *   `update_version.sh`: A shell script to find and replace version strings across the project.
*   `tests/`: Contains files related to testing:
    *   `phpstan/`: Configuration and bootstrap files for PHPStan static analysis.
    *   `unit/`: Bootstrap for PHPUnit tests (current unit test suite seems minimal).
*   `uninstall.php`: Script executed upon plugin uninstallation to clean up resources (like the custom options database table).

### Coding Conventions and Standards

*   The project uses **PHP_CodeSniffer (`phpcs`)** for enforcing coding standards. The specific ruleset is defined in `tools/phpcs.xml`. It is largely based on the `WordPress` coding standard but includes several customizations and excluded rules (e.g., regarding line length, indentation, and specific WordPress sniffs).
*   **PHPStan** is used for static analysis to detect potential bugs and type errors. Its configuration is in `phpstan.neon`, set to `level: max`.
*   PHP Compatibility checks are performed using `PHPCompatibilityWP` standard via Composer scripts to ensure compatibility with specified PHP versions (currently targeting >=7.3, tested against 7.3 & 7.4 in CI).
*   Composer scripts (`"lint"`, `"phpcs"`, `"phpstan"`, `"test"`) are provided for easy execution of these checks.

### Contributing

We welcome contributions to enhance the WP2Static Copy to Folder Add-on!

*   **Reporting Issues:** If you find a bug or have a feature request, please open an issue on the [GitHub repository's Issues page](https://github.com/twardoch/wp2static-addon-copy/issues).
*   **Development Setup:**
    1.  Clone the repository: `git clone https://github.com/twardoch/wp2static-addon-copy.git`
    2.  Navigate into the cloned directory: `cd wp2static-addon-copy`
    3.  Install development dependencies using Composer: `composer install`
*   **Running Tests & Linters:**
    *   To run all checks (validation, linting, coding standards, PHPStan): `composer test`
    *   To run only PHP_CodeSniffer for coding standards: `composer phpcs`
    *   To attempt to automatically fix coding standards issues: `composer phpcbf`
    *   To run only PHPStan for static analysis: `composer phpstan`
    *   To run PHPUnit tests (if any are added): `composer phpunit`
*   **Building a Release:**
    *   The `tools/build_release.sh` script is used to create a production-ready `.zip` file of the plugin. This can also be run via `composer build`.
    *   The script temporarily removes development dependencies, installs production dependencies, copies necessary files to a temporary directory, and then creates the zip archive. Afterwards, it restores development dependencies.
*   **Pull Requests:**
    1.  Fork the repository on GitHub.
    2.  Create a new branch for your feature or bug fix (e.g., `feature/new-thing` or `fix/issue-123`).
    3.  Make your changes and commit them with clear, descriptive messages.
    4.  Ensure all tests and linters pass (`composer test`).
    5.  Push your branch to your fork.
    6.  Open a pull request against the `master` branch of the `twardoch/wp2static-addon-copy` repository.

### Changelog

For a list of changes and new features, please refer to the `CHANGELOG.md` file.
*(**Developer Note:** The current `CHANGELOG.md` in the repository root seems to be for a different add-on (S3). This needs to be corrected or a specific one for this add-on should be maintained.)*

### License

The WP2Static Copy to Folder Add-on is released under the **Unlicense**. See the `LICENSE.txt` file for more details. This means it is free and unencumbered software released into the public domain.
